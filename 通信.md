# 触摸屏控制方式

## 重置位置为 0

lua 中重置位置的操作如下

```lua
-- 重置编码器的累计脉冲数，连同累计脉冲缓存和累计脉冲偏移量缓存一起清 0.
Encoder.ResetPosition = function()
	-- 位置预置
	Servo.TriggerEIRisingEdge(10)
	DD(100, 0)
	DD(101, 0)
	DD(102, 0)
end
```

这是一个多步骤的操作，如果让触摸屏执行这些步骤，触摸屏执行到一半时 lua 又进行读写，就会发生冲突。所以触摸屏设置一个 M 变量为 1，告诉 lua 来执行这个操作。lua 执行完成后将该 M 变量置为 0.



定为使用 M1 变量来告诉 lua 进行位置重置。

## 触摸屏显示当前转的圈数

脚本计算出转的圈数后，放到 D1 变量中，触摸屏读取 D1。

计算圈数时使用：

```lua
-- 总的编码器脉冲数缓存
-- 总的缓存 = 累计缓存 + 偏移量缓存
Encoder.TotalPulseCache = function()
	return Encoder.CumulativePulseCache() + Encoder.CumulativePulseOffsetCache()
end
```

将此属性除以 $2^{17}$ 得到转的圈数。

## 触摸屏进行正反转点动

要点动首先要切换到速度控制模式，然后再通过 EI 给出正反转命令。EI 的配置如下

```lua
-- EI9 配置为使能
if (Servo.GetParam(3, 9) ~= 1) then
    Servo.SetParam(3, 9, 1)
    should_restart = true
end
-- EI10 配置为位置预置功能
if (Servo.GetParam(3, 10) ~= 16) then
    Servo.SetParam(3, 10, 16)
    should_restart = true
end
-- EI11 配置为控制模式切换。为 ON 时进入速度控制模式，此时可以点动。
if (Servo.GetParam(3, 11) ~= 36) then
    Servo.SetParam(3, 11, 36)
    should_restart = true
end
-- EI12 配置为正转
if (Servo.GetParam(3, 12) ~= 2) then
    Servo.SetParam(3, 12, 2)
    should_restart = true
end
-- EI13 配置为反转
if (Servo.GetParam(3, 13) ~= 3) then
    Servo.SetParam(3, 13, 3)
    should_restart = true
end
```

触摸屏设置：

* 一个开关用来切换 EI11
* 一个按钮对应 EI12
* 一个按钮对应 EI13。